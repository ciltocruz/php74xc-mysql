version: v1.0

name: Build and test Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

global_job_config:

  prologue:
    commands:
      - echo $DOCKER_TOKEN | docker login --username "$DOCKER_USERNAME" --password-stdin

  env_vars:
    - name: DOCKER_USERNAME
      value: sineverba
    - name: DOCKER_IMAGE
      value: php74xc

blocks:
  - name: 'Build and test'
    skip:
      when: "tag =~ '.*'"
    task:
      jobs:
        - name: 'Build and test'
          commands:
            - checkout
            - docker build --tag $DOCKER_USERNAME/$DOCKER_IMAGE .
            - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -v | grep 7.4.14
            - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -v | grep OPcache
            - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -m | grep xdebug
            - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -r "xdebug_info();" | grep "3.0.2"
            - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -m | grep pdo_pgsql
            - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE /usr/bin/composer -V | grep "1.10.20"
            - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -i | grep "short_open_tag => Off => Off"
            - docker run --rm $DOCKER_USERNAME/$DOCKER_IMAGE php -i | grep "memory_limit => 512M => 512M"
            #- docker -v
            #- mkdir -vp ~/.docker/cli-plugins/
            #- curl --silent -L "https://github.com/docker/buildx/releases/download/v0.5.1/buildx-v0.5.1.linux-amd64" > ~/.docker/cli-plugins/docker-buildx
            #- chmod a+x ~/.docker/cli-plugins/docker-buildx
            #- docker buildx version
            #- docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
            #- docker buildx create --name mybuilder && docker buildx use mybuilder && docker buildx inspect --bootstrap
      secrets:
        - name: DOCKER_TOKEN